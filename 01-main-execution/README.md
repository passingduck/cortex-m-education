# 1. Main ν•¨μ μ‹¤ν–‰ κ³Όμ • λ¶„μ„ - GDBλ΅ λ””λ²„κΉ…ν•κΈ°

μ΄ μμ μ—μ„λ” Cortex-M33 λ§μ΄ν¬λ΅μ»¨νΈλ΅¤λ¬μ—μ„ C ν”„λ΅κ·Έλ¨μ main ν•¨μκ°€ μ–΄λ–»κ² μ‹¤ν–‰λλ”μ§€ GDBλ¥Ό ν™μ©ν•μ—¬ λ‹¨κ³„λ³„λ΅ λ¶„μ„ν•΄λ³΄κ² μµλ‹λ‹¤.

## π“‹ ν•™μµ λ©ν‘

- Cortex-M33 λ¶€ν… κ³Όμ • μ΄ν•΄
- λ²΅ν„° ν…μ΄λΈ”κ³Ό λ¦¬μ…‹ λ²΅ν„°μ μ—­ν• 
- main ν•¨μμ— λ„λ‹¬ν•κΈ°κΉμ§€μ κ³Όμ •
- GDBλ¥Ό ν™μ©ν• μ‹¤μ‹κ°„ λ””λ²„κΉ…

## π› οΈ μ‚¬μ „ μ¤€λΉ„

### 1. ν”„λ΅μ νΈ λΉλ“
```bash
# ν”„λ΅μ νΈ λΉλ“
make clean && make
```

### 2. GDB λ””λ²„κΉ… ν™κ²½ μ¤€λΉ„
```bash
# arm-none-eabi-gdbκ°€ μ„¤μΉλμ–΄ μλ”μ§€ ν™•μΈ
arm-none-eabi-gdb --version

# QEMUκ°€ μ„¤μΉλμ–΄ μλ”μ§€ ν™•μΈ
qemu-system-arm --version
```

## π” μ½”λ“ λ¶„μ„

### ν”„λ΅κ·Έλ¨ κµ¬μ΅°
- `src/boot.s`: λ¶€ν… μ–΄μ…λΈ”λ¦¬ μ½”λ“ (λ²΅ν„° ν…μ΄λΈ”, λ¦¬μ…‹ ν•Έλ“¤λ¬)
- `src/main.c`: C λ©”μΈ ν”„λ΅κ·Έλ¨
- `linker/cortex-m33.ld`: λ§μ»¤ μ¤ν¬λ¦½νΈ (λ©”λ¨λ¦¬ λ°°μΉ)

## π€ QEMUμ—μ„ μ‹¤ν–‰ν•λ©° λ””λ²„κΉ…

### 1λ‹¨κ³„: QEMU μ‹μ‘ λ° GDB μ—°κ²°

```bash
# ν„°λ―Έλ„ 1: QEMU μ‹¤ν–‰ (GDB μ„λ²„ λ¨λ“)
qemu-system-arm -machine mps2-an505 -cpu cortex-m33 \
    -kernel build/cortex-m33-hello-world.elf \
    -nographic -monitor none -serial stdio -s -S
```

```bash
# ν„°λ―Έλ„ 2: GDB μ‹μ‘ λ° QEMU μ—°κ²°
arm-none-eabi-gdb build/cortex-m33-hello-world.elf

# GDB ν”„λ΅¬ν”„νΈμ—μ„ μ‹¤ν–‰
(gdb) target remote localhost:1234
(gdb) load
```

**μμƒ κ²°κ³Ό:**
```
Remote debugging using localhost:1234
Loading section .text, size 0xa30 lma 0x0
Start address 0x4c, entry point 0x4c
```

### 2λ‹¨κ³„: λ²΅ν„° ν…μ΄λΈ” λ¶„μ„

```bash
# GDBμ—μ„ λ²΅ν„° ν…μ΄λΈ” ν™•μΈ (0x00000000 μ£Όμ†λ¶€ν„°)
(gdb) x/8xw 0x00000000
```

**μμƒ κ²°κ³Ό:**
```
0x0:    0x2007ffff  0x0000004d  0x00000051  0x00000051
0x10:   0x00000051  0x00000051  0x00000051  0x00000000
```

**λ²΅ν„° ν…μ΄λΈ” κµ¬μ΅°:**
- `0x00000000`: μ¤νƒ ν¬μΈν„° μ΄κΈ°κ°’ (MSP) = 0x2007ffff
- `0x00000004`: λ¦¬μ…‹ λ²΅ν„° (Reset_Handler μ£Όμ†) = 0x0000004d

### 3λ‹¨κ³„: λ¦¬μ…‹ ν•Έλ“¤λ¬μ— λΈλ μ΄ν¬ν¬μΈνΈ μ„¤μ •

```bash
# Reset_Handlerμ— λΈλ μ΄ν¬ν¬μΈνΈ μ„¤μ •
(gdb) break Reset_Handler
(gdb) info registers pc sp

# ν”„λ΅κ·Έλ¨ μ‹¤ν–‰ μ‹μ‘
(gdb) continue
```

**μμƒ κ²°κ³Ό:**
```
Breakpoint 1 at 0x4c: file src/boot.s, line 25.
pc             0x4c                0x4c <Reset_Handler>
sp             0x2007ffff          0x2007ffff
Continuing.

Breakpoint 1, Reset_Handler () at src/boot.s:25
25          ldr sp, =__StackTop
```

**π” λ μ§€μ¤ν„° λ¶„μ„:**
- **PC (Program Counter)**: 0x4c - Reset_Handler μ£Όμ†
- **SP (Stack Pointer)**: 0x2007ffff - λ²΅ν„° ν…μ΄λΈ”μ—μ„ μ„¤μ •λ μ¤νƒ μƒλ‹¨

### 4λ‹¨κ³„: Reset_Handler μ½”λ“ λ¶„μ„

```bash
# ν„μ¬ μ–΄μ…λΈ”λ¦¬ μ½”λ“ ν™•μΈ
(gdb) disassemble
(gdb) stepi    # μ–΄μ…λΈ”λ¦¬ λ…λ Ήμ–΄ λ‹¨μ„λ΅ μ‹¤ν–‰
(gdb) info registers
```

**Reset_Handlerμ μ£Όμ” μ‘μ—…:**
1. μ¤νƒ ν¬μΈν„° μ„¤μ •
2. BSS μ„Ήμ… μ΄κΈ°ν™” (μ „μ—­ λ³€μ 0μΌλ΅ μ΄κΈ°ν™”)  
3. DATA μ„Ήμ… λ³µμ‚¬ (Flashμ—μ„ RAMμΌλ΅)
4. main ν•¨μ νΈμ¶

### 5λ‹¨κ³„: main ν•¨μ μ§„μ… μ¶”μ 

```bash
# main ν•¨μμ— λΈλ μ΄ν¬ν¬μΈνΈ μ„¤μ •
(gdb) break main
(gdb) continue

# main ν•¨μ λ„λ‹¬ ν›„ λ μ§€μ¤ν„° μƒνƒ ν™•μΈ
(gdb) info registers
(gdb) info frame
```

**π” main ν•¨μ μ§„μ… μ‹ λ μ§€μ¤ν„° λ³€ν™”:**
- **PC**: main ν•¨μ μ£Όμ†λ΅ λ³€κ²½
- **SP**: μ¤νƒ ν”„λ μ„ μ„¤μ •μΌλ΅ μ•½κ°„ κ°μ†
- **LR (Link Register)**: λ¦¬ν„΄ μ£Όμ† μ €μ¥

### 6λ‹¨κ³„: main ν•¨μ λ‚΄λ¶€ λ¶„μ„

```bash
# ν„μ¬ μ†μ¤ μ½”λ“ μ„μΉ ν™•μΈ
(gdb) list
(gdb) info locals

# μ¤νƒ μƒνƒ ν™•μΈ
(gdb) backtrace
(gdb) info frame
```

### 7λ‹¨κ³„: ν•¨μ νΈμ¶ μ¶”μ 

```bash
# print_string ν•¨μμ— λΈλ μ΄ν¬ν¬μΈνΈ μ„¤μ •
(gdb) break print_string
(gdb) step    # λ‹¤μ λΌμΈμΌλ΅ μ΄λ™ (ν•¨μ λ‚΄λ¶€ μ§„μ…)
(gdb) next    # λ‹¤μ λΌμΈμΌλ΅ μ΄λ™ (ν•¨μ νΈμ¶μ„ ν• λ²μ— μ‹¤ν–‰)

# ν•¨μ νΈμ¶ μ „ν›„ μ¤νƒ ν¬μΈν„° λ³€ν™” κ΄€μ°°
(gdb) print $sp
(gdb) step
(gdb) print $sp
```

**π” ν•¨μ νΈμ¶ μ‹ λ μ§€μ¤ν„° λ³€ν™”:**
- **SP**: ν•¨μ νΈμ¶ μ‹ κ°μ† (μ¤νƒ ν”„λ μ„ μƒμ„±)
- **LR**: νΈμ¶ μ§€μ μ λ‹¤μ μ£Όμ† μ €μ¥
- **PC**: νΈμ¶λ ν•¨μμ μ‹μ‘ μ£Όμ†λ΅ λ³€κ²½

### 8λ‹¨κ³„: μ„Έλ―ΈνΈμ¤ν… λ™μ‘ λ¶„μ„

```bash
# semihost_call ν•¨μμ—μ„ λ μ§€μ¤ν„° μƒνƒ ν™•μΈ
(gdb) break semihost_call
(gdb) continue
(gdb) info registers

# μΈλΌμΈ μ–΄μ…λΈ”λ¦¬ μ½”λ“ λ¶„μ„ (SVC λ…λ Ήμ–΄)
(gdb) stepi
(gdb) disassemble $pc,$pc+8
```

**π” μ„Έλ―ΈνΈμ¤ν… λ μ§€μ¤ν„° μ‚¬μ©:**
- **R0**: μ„Έλ―ΈνΈμ¤ν… λ…λ Ήμ–΄ λ²νΈ (μ: 0x04 = SYS_WRITE0)
- **R1**: λ§¤κ°λ³€μ ν¬μΈν„°
- **SVC λ…λ Ήμ–΄**: μ‹μ¤ν… μ„λΉ„μ¤ νΈμ¶λ΅ QEMUκ°€ μ²λ¦¬

## π“ ν•™μµ κ²°κ³Ό μ •λ¦¬

### λ¶€ν… κ³Όμ • μ”μ•½

1. **ν•λ“μ›¨μ–΄ λ¦¬μ…‹**
   - CPUκ°€ 0x00000000 (λ²΅ν„° ν…μ΄λΈ” λ² μ΄μ¤) μ£Όμ†λ¥Ό μ°Έμ΅°
   - MSP(Main Stack Pointer) μ΄κΈ°ν™”
   - Reset_Handler μ£Όμ†λ΅ μ ν”„

2. **Reset_Handler μ‹¤ν–‰**
   - μ¤νƒ ν¬μΈν„° μ„¤μ • ν™•μΈ
   - BSS μ„Ήμ… 0μΌλ΅ μ΄κΈ°ν™”
   - DATA μ„Ήμ… ROMβ†’RAM λ³µμ‚¬
   - main ν•¨μ νΈμ¶

3. **main ν•¨μ μ‹¤ν–‰**
   - C λ°νƒ€μ„ ν™κ²½ μ™„μ „ μ΄κΈ°ν™” μ™„λ£
   - μ‚¬μ©μ ν”„λ΅κ·Έλ¨ λ΅μ§ μ‹¤ν–‰

### ν•µμ‹¬ κ°λ…

- **λ²΅ν„° ν…μ΄λΈ”**: μΈν„°λ½νΈμ™€ μμ™Έ μ²λ¦¬λ¥Ό μ„ν• ν•¨μ ν¬μΈν„° λ°°μ—΄
- **λ¦¬μ…‹ λ²΅ν„°**: μ‹μ¤ν… λ¶€ν… μ‹ μ‹¤ν–‰λλ” μ²« λ²μ§Έ μ‚¬μ©μ μ½”λ“
- **μ„Έλ―ΈνΈμ¤ν…**: λ””λ²„κ±°λ¥Ό ν†µν• μ…μ¶λ ¥ μ‹λ®¬λ μ΄μ…

## π”§ μ¶”κ°€ μ‹¤ν—

### 1. λΈλ μ΄ν¬ν¬μΈνΈ μ΅°μ‘
```bash
# λ¨λ“  λΈλ μ΄ν¬ν¬μΈνΈ ν™•μΈ
(gdb) info breakpoints

# λΈλ μ΄ν¬ν¬μΈνΈ μ‚­μ 
(gdb) delete 1    # λΈλ μ΄ν¬ν¬μΈνΈ λ²νΈ 1 μ‚­μ 
(gdb) clear       # ν„μ¬ μ„μΉμ λΈλ μ΄ν¬ν¬μΈνΈ μ‚­μ 
```

### 2. λ©”λ¨λ¦¬ λ¤ν”„
```bash
# μ½”λ“ μμ—­ ν™•μΈ (μ–΄μ…λΈ”λ¦¬ λ…λ Ήμ–΄λ΅)
(gdb) x/10i $pc

# λ©”λ¨λ¦¬ λ‚΄μ© ν™•μΈ (16μ§„μλ΅)
(gdb) x/16xb 0x20000000    # 16λ°”μ΄νΈλ¥Ό λ°”μ΄νΈ λ‹¨μ„λ΅ μ¶λ ¥
(gdb) x/8xw 0x00000000     # 8μ›λ“λ¥Ό μ›λ“ λ‹¨μ„λ΅ μ¶λ ¥
```

### 3. λ³€μ κ΄€μ°°
```bash
# μ§€μ—­ λ³€μ ν™•μΈ
(gdb) info locals
(gdb) info args

# νΉμ • λ³€μ κ°’ μ¶λ ¥
(gdb) print variable_name
(gdb) print/x variable_name    # 16μ§„μλ΅ μ¶λ ¥
```

## π― ν€΄μ¦

1. Reset_Handlerμ—μ„ main ν•¨μκ°€ νΈμ¶λκΈ° μ „μ— μ–΄λ–¤ μ΄κΈ°ν™” μ‘μ—…λ“¤μ΄ μν–‰λλ‚μ”?
2. λ²΅ν„° ν…μ΄λΈ”μ μ²« λ²μ§Έ μ—”νΈλ¦¬λ” λ¬΄μ—‡μ΄κ³  μ™ μ¤‘μ”ν•κ°€μ”?
3. μ„Έλ―ΈνΈμ¤ν…μ€ μ–΄λ–¤ λ°©μ‹μΌλ΅ λ™μ‘ν•λ©°, μ‹¤μ  ν•λ“μ›¨μ–΄μ—μ„λ” μ–΄λ–»κ² λ€μ²΄λλ‚μ”?

---

**λ‹¤μ λ‹¨κ³„**: [02-memory-layout](../02-memory-layout/) - λ©”λ¨λ¦¬ μμ—­κ³Ό λ³€μμ μ΄ν•΄